<!DOCTYPE html>
<html>
<head>
<title>Create Invoice</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

body{
font-family:'Segoe UI';
background:#eef2f7;
margin:0;
}

.container{
max-width:900px;
margin:auto;
padding:20px;
}

.card{
background:white;
padding:25px;
border-radius:14px;
box-shadow:0 6px 20px rgba(0,0,0,0.08);
}

input,select{
width:100%;
padding:10px;
margin-top:6px;
margin-bottom:14px;
border:1px solid #ccc;
border-radius:6px;
}

button{
width:100%;
padding:12px;
border:none;
border-radius:6px;
background:#2d4a8a;
color:white;
font-weight:600;
cursor:pointer;
margin-top:8px;
}

/* ===== INVOICE DESIGN ===== */

.invoiceBox{
background:white;
padding:30px;
margin-top:30px;
border-radius:14px;
}

.invHeader{
display:flex;
justify-content:space-between;
border-bottom:2px solid #ddd;
padding-bottom:10px;
margin-bottom:20px;
}

.invNo{
color:red;
font-weight:bold;
font-size:20px;
}

table{
width:100%;
border-collapse:collapse;
}

td,th{
padding:10px;
border-bottom:1px solid #ddd;
}

.total{
font-weight:bold;
font-size:18px;
}

</style>
</head>

<body>

<div class="container">

<div class="card">

<h2>Create Invoice</h2>

<select id="party" onchange="loadCustomer()"></select>

<input id="person" placeholder="Person Name">
<input id="gstin" placeholder="GSTIN">

<label>From</label>
<input type="month" id="from">

<label>To</label>
<input type="month" id="to">

<input id="gstFee" placeholder="GST Charges / Month">
<input id="auditFee" placeholder="Audit Fee">
<input id="itrFee" placeholder="ITR Fee">

<input id="other1Title" placeholder="Other Title 1">
<input id="other1Amt" placeholder="Other Amount 1">

<input id="discount" placeholder="Discount">
<input id="payment" placeholder="Payment">

<button onclick="generateInvoice()">Generate Invoice</button>
<button onclick="saveInvoice()">Save Invoice</button>
<button onclick="downloadJPG()">Share JPG</button>

</div>

<!-- ===== INVOICE PREVIEW ===== -->

<div id="invoice" class="invoiceBox">

<div class="invHeader">

<div>
<h3>RS Associates</h3>
<div id="invParty"></div>
<div id="invGSTIN"></div>
</div>

<div>
<div class="invNo" id="invNo">RS-000</div>
<div id="invPeriod"></div>
</div>

</div>

<table>
<tbody id="billBody"></tbody>

<tfoot>

<tr class="total">
<td>Total</td>
<td id="grandTotal"></td>
</tr>

<tr>
<td>Payment</td>
<td id="paymentShow"></td>
</tr>

<tr>
<td>Balance</td>
<td id="balanceShow"></td>
</tr>

</tfoot>
</table>

</div>

</div>

<script>

const API="https://backend.rajeevyadav2596.workers.dev";
let customers=[];

/* ================= LOAD CUSTOMERS ================= */

async function init(){

const res=await fetch(API+"/api/customers");
customers=await res.json();

party.innerHTML='<option>Select Party</option>';

customers.forEach(c=>{
party.innerHTML+=
`<option value="${c.id}">
${c.firm_name} - ${c.person_name}
</option>`;
});

/* PREFILL IF OPENED FROM LEDGER */

const urlParams = new URLSearchParams(window.location.search);
const invoiceNo = urlParams.get("invoice");

if(invoiceNo){
loadInvoice(invoiceNo);
}

}

init();

/* ================= LOAD CUSTOMER ================= */

function loadCustomer(){

const c=customers.find(x=>x.id==party.value);

person.value=c.person_name;
gstin.value=c.gstin;
gstFee.value=c.gst_charges;
auditFee.value=c.audit_fee;
itrFee.value=c.itr_fee;

}

/* ================= LOAD EXISTING INVOICE ================= */

async function loadInvoice(no){

const res=await fetch(API+"/api/invoice/"+no);
const d=await res.json();

party.value=d.customer_id;
person.value=d.person_name;
gstin.value=d.gstin;
from.value=d.period_from;
to.value=d.period_to;
gstFee.value=d.gst_total/d.months;
auditFee.value=d.audit_total;
itrFee.value=d.itr_total;

generateInvoice();

invNo.innerText=d.invoice_no;

}

/* ================= MONTH DIFF ================= */

function monthDiff(a,b){

const d1=new Date(a);
const d2=new Date(b);

return (d2.getFullYear()-d1.getFullYear())*12 +
(d2.getMonth()-d1.getMonth())+1;

}

/* ================= FORMAT PERIOD ================= */

function formatPeriod(f,t){

const m=["Jan","Feb","Mar","Apr","May","Jun",
"Jul","Aug","Sep","Oct","Nov","Dec"];

const d1=new Date(f);
const d2=new Date(t);

return `${m[d1.getMonth()]}-${d1.getFullYear()} 
to 
${m[d2.getMonth()]}-${d2.getFullYear()}`;

}

/* ================= GENERATE ================= */

function generateInvoice(){

const months=monthDiff(from.value,to.value);
const gstTotal=months*gstFee.value;

let total=
+gstTotal+
+ +auditFee.value+
+ +itrFee.value+
+ +other1Amt.value-
+ +discount.value;

let balance=total-(+payment.value||0);

invParty.innerText=party.options[party.selectedIndex].text;
invGSTIN.innerText="GSTIN: "+gstin.value;
invPeriod.innerText=formatPeriod(from.value,to.value);

billBody.innerHTML=`
<tr><td>GST Filing (${months} Months)</td><td>₹${gstTotal}</td></tr>
<tr><td>Audit</td><td>₹${auditFee.value}</td></tr>
<tr><td>ITR</td><td>₹${itrFee.value}</td></tr>
<tr><td>${other1Title.value}</td><td>₹${other1Amt.value}</td></tr>
<tr><td style="color:red;">Discount</td><td style="color:red;">-₹${discount.value}</td></tr>
`;

grandTotal.innerText="₹ "+total;
paymentShow.innerText="₹ "+(+payment.value||0);
balanceShow.innerText="₹ "+balance;

}

/* ================= SAVE ================= */

async function saveInvoice(){

const months=monthDiff(from.value,to.value);
const gstTotal=months*gstFee.value;

const total=
+gstTotal+
+ +auditFee.value+
+ +itrFee.value+
+ +other1Amt.value-
+ +discount.value;

const res=await fetch(API+"/api/add-invoice",{
method:"POST",
headers:{ "Content-Type":"application/json" },
body:JSON.stringify({

customer_id:party.value,
from:from.value,
to:to.value,
months,
gst_total:gstTotal,
audit_total:auditFee.value,
itr_total:itrFee.value,

other1_name:other1Title.value,
other1_amount:other1Amt.value,

discount:discount.value,
payment:payment.value,

final_total:total

})
});

const data=await res.json();
invNo.innerText=data.invoice_no;

alert("Invoice Saved");

}

/* ================= JPG ================= */

function downloadJPG(){

html2canvas(document.getElementById("invoice"))
.then(canvas=>{
const file=canvas.toDataURL();
window.open(file);
});

}

</script>

</body>
</html>
