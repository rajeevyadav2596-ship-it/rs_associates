<!DOCTYPE html>
<html>
<head>
<title>Customer Master</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

body{
margin:0;
font-family:'Segoe UI',sans-serif;
background:#eef2f7;
}

/* HEADER */

.header{
display:flex;
justify-content:space-between;
align-items:center;
background:#1f3c88;
color:white;
padding:15px 20px;
}

.header h2{
margin:0;
font-weight:500;
}

.header a{
color:white;
text-decoration:none;
font-size:14px;
}

/* CONTAINER */

.container{
max-width:700px;
margin:30px auto;
padding:20px;
}

.card{
background:white;
padding:25px;
border-radius:14px;
box-shadow:0 6px 20px rgba(0,0,0,0.08);
}

/* INPUTS */

label{
font-size:14px;
color:#333;
}

input,select{
width:100%;
padding:10px;
margin-top:6px;
margin-bottom:14px;
border:1px solid #ccc;
border-radius:6px;
font-size:14px;
}

/* BUTTONS */

button{
width:100%;
padding:12px;
border:none;
border-radius:6px;
font-weight:600;
cursor:pointer;
margin-top:6px;
}

.save{ background:#2d4a8a; color:white; }
.delete{ background:#c0392b; color:white; }

/* MOBILE */

@media(max-width:600px){
.header{
flex-direction:column;
align-items:flex-start;
gap:8px;
}
}

</style>
</head>

<body>

<div class="header">
<h2>Customer Master</h2>
<a href="index.html">← Back To Dashboard</a>
</div>

<div class="container">
<div class="card">

<label>Select Party</label>
<select id="partyDropdown" onchange="selectCustomer()">
<option value="">-- Select Customer --</option>
</select>

<label>Firm Name</label>
<input id="firm" onblur="formatName('firm')">

<label>Person Name</label>
<input id="person" onblur="formatName('person')">

<label>GSTIN No</label>
<input id="gstin">

<label>GST Charges / Month</label>
<input id="gst" type="number">

<label>Audit Fee</label>
<input id="audit" type="number">

<label>ITR Fee</label>
<input id="itr" type="number">

<label>Other Fee Title</label>
<input id="otherTitle">

<label>Other Fee Amount</label>
<input id="otherAmount" type="number">

<button class="save" onclick="saveCustomer()">Save / Update</button>
<button class="delete" onclick="deleteCustomer()">Delete</button>

</div>
</div>

<script>

const API = "https://backend.rajeevyadav2596.workers.dev";

let customers=[];
let selectedId=null;

/* ================= FORMAT NAME ================= */

function formatName(id){

let value = document.getElementById(id).value;

value = value
.toLowerCase()
.split(" ")
.map(w => w.charAt(0).toUpperCase() + w.slice(1))
.join(" ");

document.getElementById(id).value = value;

}

/* ================= NORMALIZE ================= */

function normalizeName(str){
return str
.toLowerCase()
.replace(/\s+/g,"")
.replace(/[^a-z0-9]/g,"");
}

/* ================= LOAD CUSTOMERS ================= */

async function loadCustomers(){

const res = await fetch(API+"/api/customers");
customers = await res.json();

partyDropdown.innerHTML =
'<option value="">-- Select Customer --</option>';

customers.forEach(c=>{

partyDropdown.innerHTML +=
`<option value="${c.id}">
${c.firm_name} - ${c.person_name}
</option>`;

});

}

/* ================= SELECT ================= */

function selectCustomer(){

const id = partyDropdown.value;
if(!id) return;

const c = customers.find(x=>x.id==id);
selectedId = id;

firm.value=c.firm_name;
person.value=c.person_name;
gstin.value=c.gstin||"";
gst.value=c.gst_charges||0;
audit.value=c.audit_fee||0;
itr.value=c.itr_fee||0;
otherTitle.value=c.other_fee_name||"";
otherAmount.value=c.other_fee_amount||0;

}

/* ================= SAVE ================= */

async function saveCustomer(){

if(!firm.value || !person.value){
alert("Enter Firm & Person Name");
return;
}

/* DUPLICATE CHECK */

const newKey =
normalizeName(firm.value + person.value);

const duplicate = customers.find(c=>{

if(c.id == selectedId) return false;

const existingKey =
normalizeName(c.firm_name + c.person_name);

return existingKey === newKey;
});

if(duplicate){
alert("Duplicate Customer Not Allowed ❌");
return;
}

/* SAVE */

await fetch(API+"/api/add-customer",{
method:"POST",
headers:{ "Content-Type":"application/json" },
body:JSON.stringify({
id:selectedId,
firm:firm.value,
person:person.value,
gstin:gstin.value,
gst:gst.value,
audit:audit.value,
itr:itr.value,
other_name:otherTitle.value,
other_amount:otherAmount.value
})
});

alert("Saved ✅");
selectedId=null;
loadCustomers();

}

/* ================= DELETE ================= */

async function deleteCustomer(){

if(!selectedId){
alert("Select customer first");
return;
}

if(!confirm("Delete this customer?")) return;

await fetch(API+"/api/delete-customer",{
method:"POST",
headers:{ "Content-Type":"application/json" },
body:JSON.stringify({ id:selectedId })
});

alert("Deleted ✅");

selectedId=null;
loadCustomers();

firm.value="";
person.value="";
gstin.value="";
gst.value="";
audit.value="";
itr.value="";
otherTitle.value="";
otherAmount.value="";

}

/* INIT */

loadCustomers();

</script>

</body>
</html>
