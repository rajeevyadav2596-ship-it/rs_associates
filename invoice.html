<!DOCTYPE html>
<html>
<head>
<title>Create Invoice</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

body{
font-family:'Segoe UI';
background:#eef2f7;
margin:0;
padding:15px;
}

/* FORM */

.card{
background:white;
padding:20px;
border-radius:14px;
max-width:900px;
margin:auto;
box-shadow:0 6px 20px rgba(0,0,0,0.08);
}

label{
font-weight:600;
font-size:14px;
display:block;
margin-top:10px;
}

input,select{
width:100%;
padding:10px;
margin-top:5px;
border:1px solid #ccc;
border-radius:6px;
}

button{
width:100%;
padding:12px;
border:none;
border-radius:6px;
background:#2d4a8a;
color:white;
font-weight:600;
margin-top:10px;
cursor:pointer;
}

/* ===== INVOICE ===== */

.invoice{
background:white;
margin-top:25px;
padding:20px;
border-radius:14px;
max-width:900px;
margin:auto;
overflow-x:auto;
}

.top{
display:flex;
justify-content:space-between;
flex-wrap:wrap;
}

.party{
color:green;
font-weight:bold;
font-size:18px;
text-transform:capitalize;
}

.gstin{
font-weight:bold;
margin-top:5px;
}

.right{
text-align:right;
}

.invNo{
color:red;
font-weight:bold;
font-size:18px;
}

/* DATE + PERIOD BOX */

.metaBox{
border:2px solid #000;
padding:8px 12px;
margin-top:15px;
font-weight:bold;
display:inline-block;
}

/* TABLE */

table{
width:100%;
border-collapse:collapse;
margin-top:20px;
}

th{
border-bottom:2px solid #000;
padding:10px;
text-align:left;
}

td{
border-bottom:1px solid #ddd;
padding:10px;
}

.gstRate{
font-weight:bold;
}

.gstRate span{
color:red;
}

.discount{
color:red;
font-weight:bold;
}

.total{
font-weight:bold;
font-size:18px;
}

/* MOBILE */

@media(max-width:600px){

.top{
flex-direction:column;
gap:8px;
}

.right{
text-align:left;
}

}

</style>
</head>

<body>

<div class="card">

<h2>Create Invoice</h2>

<label>Select Party</label>
<select id="party" onchange="loadCustomer()"></select>

<label>Person Name</label>
<input id="person">

<label>GSTIN</label>
<input id="gstin">

<label>From</label>
<input type="month" id="from">

<label>To</label>
<input type="month" id="to">

<label>GST Charges / Month</label>
<input id="gstFee">

<label>Audit</label>
<input id="auditFee">

<label>ITR</label>
<input id="itrFee">

<label>Other Title</label>
<input id="otherTitle">

<label>Other Amount</label>
<input id="otherAmt">

<label>Discount</label>
<input id="discount">

<button onclick="generateInvoice()">Generate Invoice</button>
<button onclick="shareJPG()">Share JPG</button>

</div>

<!-- ===== INVOICE ===== -->

<div id="invoice" class="invoice">

<div class="top">

<div>
<h3>RS Associates</h3>
<div class="party" id="invParty"></div>
<div class="gstin" id="invGSTIN"></div>
</div>

<div class="right">
<div class="invNo" id="invNo"></div>
</div>

</div>

<div class="metaBox" id="metaBox"></div>

<table>

<thead>
<tr>
<th>Particulars</th>
<th>Amount (₹)</th>
</tr>
</thead>

<tbody id="billBody"></tbody>

<tfoot>
<tr class="total">
<td>Total</td>
<td id="grandTotal"></td>
</tr>
</tfoot>

</table>

</div>

<script>

const API="https://backend.rajeevyadav2596.workers.dev";
let customers=[];

/* LOAD */
async function init(){

const res=await fetch(API+"/api/customers");
customers=await res.json();

party.innerHTML='<option>Select Party</option>';

customers.forEach(c=>{
party.innerHTML+=
`<option value="${c.id}">
${c.firm_name} - ${c.person_name}
</option>`;
});

}

/* LOAD CUSTOMER */
function loadCustomer(){

const c=customers.find(x=>x.id==party.value);

person.value=c.person_name;
gstin.value=c.gstin;
gstFee.value=c.gst_charges;
auditFee.value=c.audit_fee;
itrFee.value=c.itr_fee;

}

/* MONTH CALC */
function monthDiff(a,b){

const d1=new Date(a);
const d2=new Date(b);

return (d2.getFullYear()-d1.getFullYear())*12 +
(d2.getMonth()-d1.getMonth())+1;

}

/* PERIOD FORMAT */
function formatPeriod(f,t){

const m=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

const d1=new Date(f);
const d2=new Date(t);

return `${m[d1.getMonth()]} ${d1.getFullYear()} to ${m[d2.getMonth()]} ${d2.getFullYear()}`;

}

/* GENERATE */
function generateInvoice(){

const months=monthDiff(from.value,to.value);
const gstTotal=months*gstFee.value;

let total=
+gstTotal+
+auditFee.value+
+itrFee.value+
+otherAmt.value-
+discount.value;

invParty.innerText=party.options[party.selectedIndex].text;
invGSTIN.innerText="GSTIN: "+gstin.value;
invNo.innerText="RS-"+Math.floor(Math.random()*1000);

metaBox.innerText=
`Date: ${new Date().toLocaleDateString()} | Billing Period: ${formatPeriod(from.value,to.value)}`;

let html="";

if(gstTotal>0){

html+=`
<tr>
<td>
GST Filing (${months} Months)
<div class="gstRate">
GST Fees — <span>₹${gstFee.value} / Month</span>
</div>
</td>
<td>₹${gstTotal}</td>
</tr>`;
}

if(auditFee.value>0)
html+=`<tr><td>Audit</td><td>₹${auditFee.value}</td></tr>`;

if(itrFee.value>0)
html+=`<tr><td>ITR</td><td>₹${itrFee.value}</td></tr>`;

if(otherAmt.value>0)
html+=`<tr><td>${otherTitle.value}</td><td>₹${otherAmt.value}</td></tr>`;

if(discount.value>0)
html+=`<tr class="discount"><td>Discount</td><td>-₹${discount.value}</td></tr>`;

billBody.innerHTML=html;
grandTotal.innerText="₹ "+total;

}

/* SHARE */
function shareJPG(){

html2canvas(invoice).then(canvas=>{
canvas.toBlob(blob=>{
const file=new File([blob],"Invoice.jpg",{type:"image/jpeg"});
navigator.share({ files:[file], title:"Invoice" });
});
});

}

init();

</script>

</body>
</html>
