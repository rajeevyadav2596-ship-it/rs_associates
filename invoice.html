<!DOCTYPE html>
<html>
<head>
<title>Invoice</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

body{
font-family:Segoe UI;
background:#eef2f7;
padding:25px;
}

.card{
background:white;
padding:25px;
border-radius:12px;
max-width:750px;
margin:auto;
box-shadow:0 4px 14px rgba(0,0,0,0.1);
}

h2{color:#1f3c88;margin-top:0;}

label{
font-weight:600;
display:block;
margin-top:14px;
}

input,select{
width:100%;
padding:10px;
border:1px solid #ccc;
border-radius:6px;
margin-top:5px;
}

.grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:10px;
}

button{
margin-top:18px;
padding:12px;
background:#1f3c88;
color:white;
border:none;
border-radius:8px;
cursor:pointer;
width:100%;
}

.preview{
margin-top:25px;
padding:20px;
border:1px solid #ddd;
border-radius:10px;
display:none;
}

.row{
display:flex;
justify-content:space-between;
margin-top:6px;
}

</style>
</head>

<body>

<div class="card">

<h2>RS Associates — Invoice</h2>

<label>Firm Name</label>
<select id="firmSelect"></select>

<label>Person Name</label>
<input id="person">

<div class="grid">
<div>
<label>Invoice No</label>
<input id="invoiceNo" readonly>
</div>

<div>
<label>Date</label>
<input id="date">
</div>
</div>

<label>Time Period</label>
<div class="grid">
<input type="month" id="from">
<input type="month" id="to">
</div>

<label>GST Fees</label>
<input id="gst" type="number" oninput="calc()">

<label>Audit</label>
<input id="audit">

<label>ITR</label>
<input id="itr">

<label>Other</label>
<input id="other" type="number">

<button onclick="saveInvoice()">Save / Update Invoice</button>
<button onclick="copyJPG()">Copy Invoice JPG</button>

<div id="preview" class="preview"></div>

</div>

<script>

const API="https://backend.rajeevyadav2596.workers.dev";

let customers=[];
let editMode=false;

/* LOAD CUSTOMERS */
async function loadCustomers(){

const res=await fetch(API+"/api/customers");
customers=await res.json();

customers.forEach(c=>{
firmSelect.innerHTML+=
`<option value="${c.id}">
${c.firm_name}
</option>`;
});

checkEditMode();
}
loadCustomers();

/* CHECK URL */
function checkEditMode(){

const params=new URLSearchParams(location.search);
const inv=params.get("invoice");

if(inv){
editMode=true;
loadInvoice(inv);
}else{
newInvoice();
}

}

/* NEW INVOICE */
function newInvoice(){

let n=localStorage.invNo||0;
n++;
localStorage.invNo=n;

invoiceNo.value="RS-"+n;
date.value=new Date().toLocaleDateString("en-GB");

}

/* LOAD EXISTING */
async function loadInvoice(no){

const res=await fetch(API+"/api/invoice/"+no);
const d=await res.json();

firmSelect.value=d.customer_id;
person.value=d.person_name;
invoiceNo.value=d.invoice_no;
date.value=new Date(d.created_at).toLocaleDateString("en-GB");

gst.value=d.gst_total;
audit.value=d.audit_total;
itr.value=d.itr_total;
other.value=d.other_total;

from.value=d.period_from;
to.value=d.period_to;

}

/* CALC */
function calc(){
audit.value=gst.value;
itr.value=gst.value;
}

/* SAVE OR UPDATE */
async function saveInvoice(){

const body={
customer_id:firmSelect.value,
invoice_no:invoiceNo.value,
from:from.value,
to:to.value,
gst_total:+gst.value||0,
audit_total:+audit.value||0,
itr_total:+itr.value||0,
other_total:+other.value||0,
final_total:
(+gst.value||0)+
(+audit.value||0)+
(+itr.value||0)+
(+other.value||0)
};

/* IF EDIT */
if(editMode){

await fetch(API+"/api/update-invoice",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(body)
});

alert("Invoice Updated ✅");

}else{

await fetch(API+"/api/add-invoice",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(body)
});

alert("Invoice Saved ✅");

}

showPreview(body);
}

/* PREVIEW */
function showPreview(d){

preview.style.display="block";

preview.innerHTML=`
<h3>Invoice ${d.invoice_no}</h3>
<div class="row"><span>GST</span><span>₹${d.gst_total}</span></div>
<div class="row"><span>Audit</span><span>₹${d.audit_total}</span></div>
<div class="row"><span>ITR</span><span>₹${d.itr_total}</span></div>
<div class="row"><span>Other</span><span>₹${d.other_total}</span></div>
<hr>
<b>Total ₹${d.final_total}</b>
`;
}

/* JPG */
async function copyJPG(){

const canvas=await html2canvas(preview);

canvas.toBlob(async blob=>{
await navigator.clipboard.write([
new ClipboardItem({"image/png":blob})
]);
alert("Copied JPG ✅");
});

}

</script>

</body>
</html>
