<!DOCTYPE html>
<html>
<head>
<title>Sale Invoice</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

body{
font-family:Segoe UI;
background:#eef2f7;
margin:0;
padding:15px;
}

.card{
background:white;
padding:20px;
border-radius:14px;
max-width:900px;
margin:auto;
box-shadow:0 6px 20px rgba(0,0,0,0.08);
margin-bottom:25px;
}

label{
font-weight:600;
display:block;
margin-top:12px;
}

input,select{
width:100%;
padding:10px;
margin-top:5px;
border:1px solid #ccc;
border-radius:6px;
}

button{
width:100%;
padding:12px;
border:none;
border-radius:6px;
background:#2d4a8a;
color:white;
font-weight:600;
margin-top:12px;
cursor:pointer;
}

.deleteBtn{
background:#c0392b;
}

.invoice{
background:white;
padding:20px;
border-radius:14px;
max-width:900px;
margin:auto;
}

.header{
display:flex;
justify-content:space-between;
}

.right{text-align:right;}

.invNo{
color:red;
font-weight:bold;
font-size:20px;
}

.date{font-weight:bold;}

.party{
color:green;
font-weight:bold;
font-size:20px;
margin-top:10px;
text-transform:capitalize;
}

.gstin{
font-weight:bold;
margin-top:5px;
}

.periodBox{text-align:center;margin-top:20px;}

.periodTitle{font-weight:bold;color:red;}

.period{
background:#1f3c88;
color:white;
display:inline-block;
padding:10px 20px;
border-radius:8px;
font-weight:bold;
margin-top:5px;
}

table{
width:100%;
border-collapse:collapse;
margin-top:25px;
}

th{
border-bottom:2px solid black;
padding:10px;
text-align:left;
}

th.amount{
text-align:right;
width:35%;
}

td{
border-bottom:1px solid #ddd;
padding:10px;
}

td.amount{
text-align:right;
white-space:nowrap;
}

.discount{color:red;font-weight:bold;}

.totalRow{
font-weight:bold;
font-size:18px;
}

.due{
color:green;
font-weight:bold;
font-size:18px;
}

</style>
</head>

<body>

<div class="card">

<h2>Create Sale Invoice</h2>

<label>Select Party</label>
<select id="party" onchange="loadCustomer()"></select>

<label>Person Name</label>
<input id="person">

<label>GSTIN</label>
<input id="gstin">

<label>From</label>
<input type="month" id="from">

<label>To</label>
<input type="month" id="to">

<label>GST Charges / Month</label>
<input id="gstFee">

<label>Audit</label>
<input id="auditFee">

<label>ITR</label>
<input id="itrFee">

<label>Other Title 1</label>
<input id="other1Title">
<input id="other1Amt">

<label>Other Title 2</label>
<input id="other2Title">
<input id="other2Amt">

<label>Other Title 3</label>
<input id="other3Title">
<input id="other3Amt">

<label>Discount</label>
<input id="discount">

<label>Payment</label>
<input id="payment">

<button onclick="saveInvoice()">Save Invoice</button>
<button class="deleteBtn" onclick="deleteInvoice()">Delete Invoice</button>
<button onclick="shareJPG()">Share JPG</button>

</div>

<div id="invoice" class="invoice">

<div class="header">
<div><h2>RS Associates</h2></div>

<div class="right">
<div class="invNo" id="invNo"></div>
<div class="date" id="invDate"></div>
</div>
</div>

<div class="party" id="invParty"></div>
<div class="gstin" id="invGSTIN"></div>

<div class="periodBox">
<div class="periodTitle">Billing Period</div>
<div class="period" id="invPeriod"></div>
</div>

<table>
<thead>
<tr>
<th>Particulars</th>
<th class="amount">Amount</th>
</tr>
</thead>

<tbody id="billBody"></tbody>

<tfoot>
<tr class="totalRow">
<td>Total</td>
<td class="amount" id="grandTotal"></td>
</tr>

<tr>
<td>Payment</td>
<td class="amount" id="paymentDisplay"></td>
</tr>

<tr class="due">
<td>Due Balance</td>
<td class="amount due" id="balanceDisplay"></td>
</tr>
</tfoot>

</table>

</div>

<script>

const API="https://backend.rajeevyadav2596.workers.dev";
let customers=[];
let editInvoiceNo=null;

/* LOAD CUSTOMERS */

async function init(){
const res=await fetch(API+"/api/customers");
customers=await res.json();

party.innerHTML='<option value="">Select Party</option>';

customers.forEach(c=>{
party.innerHTML+=`
<option value="${c.id}">
${c.firm_name} - ${c.person_name}
</option>`;
});

await loadInvoiceIfEdit();
}

/* LOAD EXISTING INVOICE */

async function loadInvoiceIfEdit(){

const params=new URLSearchParams(window.location.search);
const no =
params.get("no") ||
params.get("invoice");

if(!no) return;

editInvoiceNo=no;

const res=await fetch(API+"/api/invoice/"+no);
const d=await res.json();
if(!d || !d.invoice_no) return;

party.value=d.customer_id;
loadCustomer();

person.value=d.person_name;
gstin.value=d.gstin;

from.value=d.period_from;
to.value=d.period_to;

auditFee.value=d.audit_total;
itrFee.value=d.itr_total;

other1Title.value=d.other1_name;
other1Amt.value=d.other1_amount;

other2Title.value=d.other2_name;
other2Amt.value=d.other2_amount;

other3Title.value=d.other3_name;
other3Amt.value=d.other3_amount;

discount.value=d.discount;
payment.value=d.payment;

invNo.innerText=d.invoice_no;

generateInvoice();
}

/* AUTO FILL */

function loadCustomer(){
const c=customers.find(x=>x.id==party.value);
if(!c) return;

person.value=c.person_name;
gstin.value=c.gstin;
gstFee.value=c.gst_charges;
auditFee.value=c.audit_fee;
itrFee.value=c.itr_fee;
}

/* MONTH DIFF */

function monthDiff(a,b){
const d1=new Date(a);
const d2=new Date(b);
return (d2.getFullYear()-d1.getFullYear())*12+
(d2.getMonth()-d1.getMonth())+1;
}

/* PERIOD FORMAT */

function formatPeriod(f,t){
const m=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const d1=new Date(f);
const d2=new Date(t);
return `${m[d1.getMonth()]} ${d1.getFullYear()} to ${m[d2.getMonth()]} ${d2.getFullYear()}`;
}

/* GENERATE */

function generateInvoice(){

const months=monthDiff(from.value,to.value);
const gstTotal=months*(+gstFee.value||0);

let total=
gstTotal+
(+auditFee.value||0)+
(+itrFee.value||0)+
(+other1Amt.value||0)+
(+other2Amt.value||0)+
(+other3Amt.value||0)-
(+discount.value||0);

let balance=total-(+payment.value||0);

invParty.innerText=party.options[party.selectedIndex]?.text || "";
invGSTIN.innerText="GSTIN: "+gstin.value;
invDate.innerText=new Date().toLocaleDateString();
invPeriod.innerText=formatPeriod(from.value,to.value);

let html="";

if(gstTotal>0){
html+=`
<tr>
<td>
GST Filing (${months} Months)
<br><b>GST Fees — ₹${gstFee.value} / Month</b>
</td>
<td class="amount">₹${gstTotal}</td>
</tr>`;
}

if(auditFee.value>0)
html+=`<tr><td>Audit</td><td class="amount">₹${auditFee.value}</td></tr>`;

if(itrFee.value>0)
html+=`<tr><td>ITR</td><td class="amount">₹${itrFee.value}</td></tr>`;

if(other1Amt.value>0)
html+=`<tr><td>${other1Title.value}</td><td class="amount">₹${other1Amt.value}</td></tr>`;

if(other2Amt.value>0)
html+=`<tr><td>${other2Title.value}</td><td class="amount">₹${other2Amt.value}</td></tr>`;

if(other3Amt.value>0)
html+=`<tr><td>${other3Title.value}</td><td class="amount">₹${other3Amt.value}</td></tr>`;

if(discount.value>0)
html+=`<tr class="discount"><td>Discount</td><td class="amount">-₹${discount.value}</td></tr>`;

billBody.innerHTML=html;

grandTotal.innerText="₹ "+total;
paymentDisplay.innerText="₹ "+(+payment.value||0);
balanceDisplay.innerText="₹ "+balance;
}

/* SAVE */

async function saveInvoice(){

generateInvoice();

const months=monthDiff(from.value,to.value);
const gstTotal=months*(+gstFee.value||0);

let total=
gstTotal+
(+auditFee.value||0)+
(+itrFee.value||0)+
(+other1Amt.value||0)+
(+other2Amt.value||0)+
(+other3Amt.value||0)-
(+discount.value||0);

const res=await fetch(API+"/api/add-invoice",{
method:"POST",
headers:{ "Content-Type":"application/json" },
body:JSON.stringify({

invoice_no:editInvoiceNo,

customer_id:party.value,
from:from.value,
to:to.value,
months:months,

gst_total:gstTotal,
audit_total:+auditFee.value||0,
itr_total:+itrFee.value||0,

other1_name:other1Title.value,
other1_amount:+other1Amt.value||0,
other2_name:other2Title.value,
other2_amount:+other2Amt.value||0,
other3_name:other3Title.value,
other3_amount:+other3Amt.value||0,

discount:+discount.value||0,
payment:+payment.value||0,
final_total:total

})
});

const data=await res.json();

editInvoiceNo=data.invoice_no;
invNo.innerText=data.invoice_no;

alert(editInvoiceNo ? "Invoice Updated ✅" : "Invoice Saved ✅");
}

/* DELETE */

async function deleteInvoice(){

if(!editInvoiceNo){
alert("No invoice to delete");
return;
}

const confirmDelete = confirm(
"Are you sure you want to delete this invoice?\nThis action cannot be undone."
);

if(!confirmDelete) return;

await fetch(API+"/api/delete-invoice",{
method:"POST",
headers:{ "Content-Type":"application/json" },
body:JSON.stringify({ invoice_no:editInvoiceNo })
});

alert("Invoice Deleted ✅");

window.location.href="ledger.html";
}

/* SHARE JPG */

function shareJPG(){
html2canvas(invoice).then(canvas=>{
canvas.toBlob(blob=>{
const file=new File([blob],"Invoice.jpg",{type:"image/jpeg"});
navigator.share({ files:[file], title:"Invoice" });
});
});
}

init();

</script>

</body>
</html>
