<!DOCTYPE html>
<html>
<head>
<title>Create Invoice</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

body{
font-family:Segoe UI;
background:#eef2f7;
padding:30px;
}

.card{
background:white;
padding:25px;
border-radius:12px;
max-width:750px;
margin:auto;
box-shadow:0 4px 14px rgba(0,0,0,0.1);
}

h2{
color:#1f3c88;
margin-top:0;
}

label{
font-weight:600;
display:block;
margin-top:15px;
}

input,select{
width:100%;
padding:10px;
border:1px solid #ccc;
border-radius:6px;
margin-top:5px;
}

.grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:10px;
}

button{
margin-top:20px;
padding:12px;
background:#1f3c88;
color:white;
border:none;
border-radius:8px;
cursor:pointer;
width:100%;
}

.invoice-preview{
margin-top:25px;
padding:20px;
border:1px solid #ddd;
border-radius:10px;
background:white;
display:none;
}

.row{
display:flex;
justify-content:space-between;
margin-top:8px;
}

@media(max-width:600px){
.grid{grid-template-columns:1fr;}
}

</style>
</head>

<body>

<div class="card">

<h2>RS Associates — Create Invoice</h2>

<label>Firm Name</label>
<select id="firmSelect" onchange="fillCustomer()"></select>

<label>Person Name</label>
<input id="person" readonly>

<div class="grid">

<div>
<label>Invoice No</label>
<input id="invoiceNo" readonly>
</div>

<div>
<label>Date</label>
<input id="date" readonly>
</div>

</div>

<label>Time Period</label>
<div class="grid">
<input type="month" id="from">
<input type="month" id="to">
</div>

<label>GST Fees</label>
<input id="gst" type="number" oninput="autoCalc()">

<label>Audit Fees</label>
<input id="audit" readonly>

<label>ITR Fees</label>
<input id="itr" readonly>

<label>Other Charges</label>
<input id="other" type="number" oninput="autoCalc()">

<button onclick="generateInvoice()">Generate Invoice</button>
<button onclick="copyJPG()">Copy Invoice JPG</button>

<div id="invoiceBox" class="invoice-preview"></div>

</div>

<script>

const API="https://backend.rajeevyadav2596.workers.dev";

let customers=[];

/* LOAD CUSTOMERS */
async function loadCustomers(){

const res=await fetch(API+"/api/customers");
customers=await res.json();

firmSelect.innerHTML="<option>Select Firm</option>";

customers.forEach(c=>{
firmSelect.innerHTML+=
`<option value="${c.id}">
${c.firm_name}
</option>`;
});
}
loadCustomers();

/* AUTO FILL CUSTOMER */
function fillCustomer(){

const c=customers.find(x=>x.id==firmSelect.value);

person.value=c.person_name;
gst.value=c.gst_charges;
audit.value=c.audit_fee;
itr.value=c.itr_fee;
}

/* AUTO CALC */
function autoCalc(){

audit.value=gst.value;
itr.value=gst.value;
}

/* INVOICE NUMBER SERIES */
function getInvoiceNo(){

let n=localStorage.getItem("invNo")||0;
n++;
localStorage.setItem("invNo",n);

return "RS-"+n;
}

/* DATE */
date.value=new Date().toLocaleDateString("en-GB");

/* GENERATE + SAVE */
async function generateInvoice(){

const invNo=getInvoiceNo();
invoiceNo.value=invNo;

const total=
(+gst.value||0)+
(+audit.value||0)+
(+itr.value||0)+
(+other.value||0);

/* SAVE TO DB */
await fetch(API+"/api/add-invoice",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
customer_id:firmSelect.value,
invoice_no:invNo,
from:from.value,
to:to.value,
gst_total:+gst.value||0,
audit_total:+audit.value||0,
itr_total:+itr.value||0,
other_total:+other.value||0,
final_total:total
})
});

/* PREVIEW */
invoiceBox.style.display="block";

invoiceBox.innerHTML=`

<h3>RS Associates</h3>

<div class="row">
<span><b>Firm:</b> ${firmSelect.options[firmSelect.selectedIndex].text}</span>
<span><b>Invoice:</b> ${invNo}</span>
</div>

<div class="row">
<span><b>Person:</b> ${person.value}</span>
<span><b>Date:</b> ${date.value}</span>
</div>

<hr>

<div class="row"><span>GST</span><span>₹${gst.value}</span></div>
<div class="row"><span>Audit</span><span>₹${audit.value}</span></div>
<div class="row"><span>ITR</span><span>₹${itr.value}</span></div>
<div class="row"><span>Other</span><span>₹${other.value}</span></div>

<hr>

<div class="row">
<b>Total</b>
<b>₹${total}</b>
</div>

`;

alert("Invoice Saved ✅");

}

/* COPY JPG */
async function copyJPG(){

const canvas=await html2canvas(invoiceBox);

canvas.toBlob(async blob=>{
await navigator.clipboard.write([
new ClipboardItem({"image/png":blob})
]);
alert("Invoice Copied as JPG");
});

}

</script>

</body>
</html>
