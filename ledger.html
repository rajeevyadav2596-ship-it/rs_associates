<!DOCTYPE html>
<html>
<head>
<title>Ledger Statement</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PDF + Canvas -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>

body{
font-family:Segoe UI;
background:#eef2f7;
padding:15px;
margin:0;
}

/* TOP BAR */

.top{
display:flex;
gap:10px;
flex-wrap:wrap;
margin-bottom:20px;
}

select,button{
padding:10px;
border-radius:6px;
border:1px solid #ccc;
font-size:14px;
}

button{
background:#2d4a8a;
color:white;
border:none;
cursor:pointer;
}

/* CARD */

.card{
background:white;
max-width:900px;
margin:auto;
padding:20px;
border-radius:14px;
box-shadow:0 6px 18px rgba(0,0,0,.08);
}

/* TITLE */

h2{
text-align:center;
margin-bottom:20px;
}

/* TABLE */

.tableWrap{
overflow-x:auto;
}

table{
width:100%;
border-collapse:collapse;
min-width:650px;
}

th{
background:#2d4a8a;
color:white;
padding:12px;
text-align:center;
font-size:14px;
}

td{
padding:10px;
border-bottom:1px solid #ddd;
text-align:center;
font-size:14px;
}

.amount{
font-weight:500;
}

/* LINKS */

.link{
cursor:pointer;
text-decoration:underline;
font-weight:600;
}

/* COLORS */

.receiptNo{
color:green;
font-weight:bold;
}

.receiptAmt{
color:green;
font-weight:bold;
}

.closingBal{
color:red;
font-weight:bold;
font-size:15px;
}

/* MOBILE FIT */

@media(max-width:600px){

th,td{
font-size:12px;
padding:8px;
}

}

</style>
</head>

<body>

<div class="top">
<select id="firm"></select>
<button onclick="loadLedger()">Search</button>
<button onclick="sharePDF()">Share PDF</button>
</div>

<div id="ledgerBox" class="card">

<h2>Ledger Statement</h2>

<div class="tableWrap">
<table>
<thead>
<tr>
<th>Date</th>
<th>Invoice</th>
<th>Particular</th>
<th>Bill</th>
<th>Receipt</th>
<th>Balance</th>
</tr>
</thead>
<tbody id="tb"></tbody>
</table>
</div>

</div>

<script>

const API="https://backend.rajeevyadav2596.workers.dev";

/* LOAD CUSTOMERS */

fetch(API+"/api/customers")
.then(r=>r.json())
.then(d=>{
firm.innerHTML='<option value="">Select Party</option>';
d.forEach(c=>{
firm.innerHTML+=
`<option value="${c.id}">
${c.firm_name} - ${c.person_name}
</option>`;
});
});

/* FORMAT DATE */

function formatDate(dt){
return new Date(dt).toLocaleDateString("en-GB");
}

/* FORMAT PERIOD */

function formatPeriod(f,t){

if(!f || !t) return "";

const months=["Jan","Feb","Mar","Apr","May","Jun",
"Jul","Aug","Sep","Oct","Nov","Dec"];

let d1=new Date(f);
let d2=new Date(t);

return `${months[d1.getMonth()]}-${d1.getFullYear()} 
to 
${months[d2.getMonth()]}-${d2.getFullYear()}`;
}

/* FORMAT NUMBER */

function formatNumber(n){
return Number(n).toLocaleString("en-IN");
}

/* LOAD LEDGER */

async function loadLedger(){

const res = await fetch(API+"/api/ledger-dashboard");
const data = await res.json();

const filtered = data.filter(x=>x.customer_id==firm.value);

let bal=0;
tb.innerHTML="";

filtered.forEach((d,i)=>{

let bill=Number(d.bill)||0;
let receipt=Number(d.receipt)||0;

bal+=bill;
bal-=receipt;

let particular="";

/* ENTRY TYPE */

if(d.invoice_no?.startsWith("RS-")){
particular=formatPeriod(d.period_from,d.period_to);
}
else{
particular=d.particular || "Receipt";
}

/* CLICK ROUTING */

let click="";
let invoiceClass="link";

if(d.invoice_no?.startsWith("RS-")){
click=`onclick="openInvoice('${d.invoice_no}')"`
}
else if(d.invoice_no?.startsWith("P-")){
click=`onclick="openReceipt('${d.invoice_no}')"`
invoiceClass+=" receiptNo";
}

/* RECEIPT COLOR */

let receiptClass = receipt ? "receiptAmt" : "";

/* CLOSING BALANCE COLOR */

let balClass = (i === filtered.length-1) ? "closingBal" : "";

tb.innerHTML+=`
<tr>
<td>${formatDate(d.date)}</td>

<td class="${invoiceClass}" ${click}>
${d.invoice_no||""}
</td>

<td>${particular}</td>

<td class="amount">
${bill?formatNumber(bill):""}
</td>

<td class="amount ${receiptClass}">
${receipt?formatNumber(receipt):""}
</td>

<td class="amount ${balClass}">
${formatNumber(bal)}
</td>
</tr>
`;

});

}

/* OPEN INVOICE */

function openInvoice(no){
window.location.href="invoice.html?invoice="+no;
}

/* OPEN RECEIPT */

function openReceipt(no){
window.location.href="receipt.html?receipt="+no;
}

/* SHARE PDF */

async function sharePDF(){

const { jsPDF } = window.jspdf;

const canvas = await html2canvas(ledgerBox,{
scale:2
});

const imgData = canvas.toDataURL("image/png");

const pdf = new jsPDF({
orientation:"portrait",
unit:"px",
format:"a4"
});

const pageWidth = pdf.internal.pageSize.getWidth();
const imgWidth = pageWidth - 20;

const imgHeight = canvas.height * imgWidth / canvas.width;

pdf.addImage(imgData,"PNG",10,10,imgWidth,imgHeight);

pdf.save("Ledger.pdf");
}

</script>

</body>
</html>
