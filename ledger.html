<!DOCTYPE html>
<html>
<head>
<title>Ledger Statement</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

/* ===== BODY ===== */

body{
font-family:Segoe UI;
background:#eef2f7;
padding:20px;
margin:0;
}

/* ===== TOP BAR ===== */

.top{
display:flex;
gap:10px;
flex-wrap:wrap;
margin-bottom:20px;
}

select,button{
padding:10px;
border-radius:6px;
border:1px solid #ccc;
font-size:14px;
}

button{
background:#2d4a8a;
color:white;
border:none;
cursor:pointer;
}

/* ===== A4 CARD ===== */

.card{
background:white;
max-width:900px;
margin:auto;
padding:25px;
border-radius:14px;
box-shadow:0 6px 18px rgba(0,0,0,.08);
}

h2{
text-align:center;
margin-bottom:20px;
}

/* ===== TABLE ===== */

table{
width:100%;
border-collapse:collapse;
}

th{
background:#2d4a8a;
color:white;
padding:12px;
text-align:center;
}

td{
padding:10px;
border-bottom:1px solid #ddd;
text-align:center;
}

.amount{
text-align:right;
white-space:nowrap;
font-weight:500;
}

.link{
color:#2d4a8a;
cursor:pointer;
text-decoration:underline;
font-weight:600;
}

/* ===== MOBILE ===== */

@media(max-width:600px){

.card{
padding:12px;
}

th,td{
font-size:12px;
padding:6px;
}

}

</style>
</head>

<body>

<!-- ===== TOP FILTER ===== -->

<div class="top">

<select id="firm"></select>

<button onclick="loadLedger()">Search</button>

<button onclick="shareJPG()">Share JPG</button>

</div>

<!-- ===== LEDGER BOX ===== -->

<div id="ledgerBox" class="card">

<h2>Ledger Statement</h2>

<table>

<thead>
<tr>
<th>Date</th>
<th>Invoice</th>
<th>Particular</th>
<th>Bill</th>
<th>Receipt</th>
<th>Balance</th>
</tr>
</thead>

<tbody id="tb"></tbody>

</table>

</div>

<script>

const API="https://backend.rajeevyadav2596.workers.dev";

let customers=[];

/* ================= LOAD CUSTOMERS ================= */

async function init(){

const res = await fetch(API+"/api/customers");
customers = await res.json();

firm.innerHTML='<option value="">Select Party</option>';

customers.forEach(c=>{

firm.innerHTML += `
<option value="${c.id}">
${c.firm_name} - ${c.person_name}
</option>`;

});

}

init();

/* ================= DATE FORMAT ================= */

function formatDate(dt){

if(!dt) return "";

const d=new Date(dt);
return d.toLocaleDateString("en-GB");

}

/* ================= PERIOD FORMAT ================= */

function formatPeriod(f,t){

if(!f || !t) return "";

const m=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

const d1=new Date(f);
const d2=new Date(t);

return `${m[d1.getMonth()]} ${d1.getFullYear()} to ${m[d2.getMonth()]} ${d2.getFullYear()}`;

}

/* ================= LOAD LEDGER ================= */

async function loadLedger(){

const res = await fetch(API+"/api/ledger-dashboard");
const data = await res.json();

const filtered = data.filter(x=>x.customer_id==firm.value);

let bal = 0;
tb.innerHTML="";

filtered.forEach(d=>{

let bill = Number(d.bill) || 0;
let receipt = Number(d.receipt) || 0;

bal += bill;
bal -= receipt;

let particular = "";

/* BILL ENTRY */

if(d.invoice_no){

particular = formatPeriod(d.period_from,d.period_to);

}

/* RECEIPT ENTRY */

else{

particular = d.entry_type || "Receipt";

}

/* ROW */

tb.innerHTML += `
<tr>

<td>${formatDate(d.date)}</td>

<td class="link"
onclick="openInvoice('${d.invoice_no}')">
${d.invoice_no || ""}
</td>

<td>${particular}</td>

<td class="amount">${bill ? "₹"+bill : ""}</td>

<td class="amount">${receipt ? "₹"+receipt : ""}</td>

<td class="amount">₹${bal}</td>

</tr>
`;

});

}

/* ================= OPEN PREFILLED INVOICE ================= */

function openInvoice(no){

if(!no) return;

window.location.href =
"invoice-create.html?invoice="+no;

}

/* ================= SHARE JPG ================= */

function shareJPG(){

html2canvas(ledgerBox).then(canvas=>{

canvas.toBlob(blob=>{

const file = new File(
[blob],
"Ledger.jpg",
{type:"image/jpeg"}
);

navigator.share({
files:[file],
title:"Ledger Statement"
});

});

});

}

</script>

</body>
</html>
