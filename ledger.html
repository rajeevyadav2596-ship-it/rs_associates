<!DOCTYPE html>
<html>
<head>
<title>Ledger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
body{font-family:Segoe UI;background:#eef2f7;padding:15px}
.table-wrap{overflow-x:auto}
table{min-width:700px;border-collapse:collapse;width:100%}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#1f3c88;color:white}
.link{color:#1f3c88;cursor:pointer;text-decoration:underline}
</style>
</head>

<body>

<select id="firm"></select>
<button onclick="load()">Search</button>
<button onclick="copy()">Copy JPG</button>

<div id="box" class="table-wrap">
<table>
<thead>
<tr>
<th>Date</th>
<th>Invoice</th>
<th>Particular</th>
<th>Dr</th>
<th>Cr</th>
<th>Bal</th>
</tr>
</thead>
<tbody id="tb"></tbody>
</table>
</div>

<script>

const API="https://backend.rajeevyadav2596.workers.dev";

fetch(API+"/api/customers")
.then(r=>r.json())
.then(d=>{
d.forEach(c=>{
firm.innerHTML+=`<option value="${c.id}">${c.firm_name}</option>`;
});
});

async function load(){

const res=await fetch(API+"/api/ledger-dashboard");
const data=await res.json();

const f=data.filter(x=>x.customer_id==firm.value);

let bal=0;tb.innerHTML="";

f.forEach(d=>{

let dr="",cr="",p="";

if(d.invoice_amount){
dr="₹"+d.invoice_amount;
bal+=d.invoice_amount;
p=d.period_from+" to "+d.period_to;
}

if(d.receipt_amount){
cr="₹"+d.receipt_amount;
bal-=d.receipt_amount;
p=d.type;
}

tb.innerHTML+=`
<tr>
<td>${d.date}</td>
<td class="link"
onclick="openInv('${d.invoice_no}')">
${d.invoice_no||""}
</td>
<td>${p}</td>
<td>${dr}</td>
<td>${cr}</td>
<td>₹${bal}</td>
</tr>`;
});

}

function openInv(no){
if(no) window.open("invoice.html?invoice="+no);
}

function copy(){
html2canvas(box).then(c=>{
navigator.clipboard.write([
new ClipboardItem({"image/png":c.toBlob(()=>{})})
]);
});
}

</script>
</body>
</html>
