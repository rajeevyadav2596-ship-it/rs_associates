<!DOCTYPE html>
<html>
<head>
<title>Ledger Dashboard</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

body{
font-family:Segoe UI;
background:#eef2f7;
padding:15px;
margin:0;
}

.card{
background:white;
padding:15px;
border-radius:12px;
max-width:1100px;
margin:auto;
box-shadow:0 4px 14px rgba(0,0,0,0.1);
}

h2{color:#1f3c88;margin-top:0;}

select{
padding:10px;
border:1px solid #ccc;
border-radius:6px;
width:100%;
margin-top:10px;
}

button{
margin-top:12px;
padding:10px 14px;
background:#1f3c88;
color:white;
border:none;
border-radius:8px;
cursor:pointer;
margin-right:6px;
font-size:14px;
}

/* Responsive Table */
.table-wrapper{
overflow-x:auto;
margin-top:15px;
}

table{
width:100%;
border-collapse:collapse;
min-width:700px;
}

th,td{
border:1px solid #ddd;
padding:8px;
text-align:center;
font-size:14px;
white-space:nowrap;
}

th{
background:#1f3c88;
color:white;
}

.invoice-link{
color:#1f3c88;
font-weight:600;
cursor:pointer;
text-decoration:underline;
}

@media(max-width:600px){

th,td{
font-size:12px;
padding:6px;
}

button{
width:100%;
margin-bottom:8px;
}

}

</style>
</head>

<body>

<div class="card">

<h2>Ledger Dashboard</h2>

<label>Select Firm</label>
<select id="firmSelect"></select>

<button onclick="loadLedger()">Search Ledger</button>
<button onclick="copyJPG()">Copy JPG</button>

<div id="ledgerBox" class="table-wrapper">

<table>
<thead>
<tr>
<th>Date</th>
<th>Invoice No</th>
<th>Particulars</th>
<th>Invoice</th>
<th>Receipt</th>
<th>Closing</th>
</tr>
</thead>

<tbody id="tbody"></tbody>

</table>

</div>

</div>

<script>

const API="https://backend.rajeevyadav2596.workers.dev";

let customers=[];

/* Load Firms */
async function loadCustomers(){

const res=await fetch(API+"/api/customers");
customers=await res.json();

firmSelect.innerHTML="<option>Select</option>";

customers.forEach(c=>{
firmSelect.innerHTML+=
`<option value="${c.id}">
${c.firm_name}
</option>`;
});
}
loadCustomers();

/* Load Ledger */
async function loadLedger(){

const id=firmSelect.value;

const res=await fetch(API+"/api/ledger-dashboard");
const data=await res.json();

const firmData=data.filter(x=>x.customer_id==id);

firmData.sort((a,b)=>new Date(a.date)-new Date(b.date));

let balance=0;
tbody.innerHTML="";

firmData.forEach(d=>{

let particular="";
let invoice="";
let receipt="";
let invNo="";

if(d.invoice_amount>0){

particular=
monthText(d.period_from)+" to "+
monthText(d.period_to);

invoice="₹"+formatMoney(d.invoice_amount);
balance+=d.invoice_amount;

invNo=`<span class="invoice-link"
onclick="openInvoice('${d.invoice_no}')">
${d.invoice_no}
</span>`;
}

if(d.receipt_amount>0){

particular=d.type;
receipt="₹"+formatMoney(d.receipt_amount);
balance-=d.receipt_amount;
}

tbody.innerHTML+=`
<tr>
<td>${formatDate(d.date)}</td>
<td>${invNo}</td>
<td>${particular}</td>
<td>${invoice}</td>
<td>${receipt}</td>
<td>₹${formatMoney(balance)}</td>
</tr>`;
});

}

/* Open Invoice */
function openInvoice(invNo){

window.open("invoice.html?invoice="+invNo,"_blank");
}

/* Format */
function monthText(m){
if(!m) return "";
return new Date(m).toLocaleString("en-GB",{month:"short",year:"2-digit"});
}

function formatDate(d){
return new Date(d).toLocaleDateString("en-GB");
}

function formatMoney(x){
return Number(x).toLocaleString("en-IN");
}

/* Copy JPG */
async function copyJPG(){

const canvas=await html2canvas(ledgerBox);

canvas.toBlob(async blob=>{
await navigator.clipboard.write([
new ClipboardItem({"image/png":blob})
]);
alert("Ledger Copied as JPG ✅");
});
}

</script>

</body>
</html>
