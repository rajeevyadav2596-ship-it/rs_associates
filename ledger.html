<!DOCTYPE html>
<html>
<head>
<title>Ledger</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<style>

body{
font-family:Segoe UI;
background:#eef2f7;
padding:20px;
}

/* TOP */

.topbar{
margin-bottom:15px;
display:flex;
gap:10px;
flex-wrap:wrap;
}

select,button{
padding:8px 12px;
border-radius:6px;
border:1px solid #ccc;
font-weight:600;
}

button{
background:#1f3c88;
color:white;
border:none;
cursor:pointer;
}

/* A4 PAGE */

.a4{
background:white;
width:210mm;
min-height:297mm;
margin:auto;
padding:25px;
box-shadow:0 0 20px rgba(0,0,0,0.1);
}

/* HEADER */

h2{
margin-top:0;
text-align:center;
}

/* TABLE */

table{
width:100%;
border-collapse:collapse;
margin-top:20px;
}

th{
background:#1f3c88;
color:white;
padding:10px;
text-align:left;
}

td{
padding:8px;
border-bottom:1px solid #ddd;
}

.amount{
text-align:right;
white-space:nowrap;
}

.link{
color:#1f3c88;
cursor:pointer;
text-decoration:underline;
font-weight:600;
}

/* MOBILE FIX */

@media(max-width:900px){
.a4{
width:100%;
min-height:auto;
}
}

</style>
</head>

<body>

<div class="topbar">
<select id="firm"></select>
<button onclick="load()">Search</button>
<button onclick="shareLedger()">Share JPG</button>
</div>

<div id="ledgerPage" class="a4">

<h2>Ledger Statement</h2>

<table>

<thead>
<tr>
<th>Date</th>
<th>Invoice</th>
<th>Particular</th>
<th class="amount">Bill</th>
<th class="amount">Receipt</th>
<th class="amount">Balance</th>
</tr>
</thead>

<tbody id="tb"></tbody>

</table>

</div>

<script>

const API="https://backend.rajeevyadav2596.workers.dev";

/* LOAD FIRMS */

fetch(API+"/api/customers")
.then(r=>r.json())
.then(d=>{
firm.innerHTML='<option value="">Select Firm</option>';
d.forEach(c=>{
firm.innerHTML+=`
<option value="${c.id}">
${c.firm_name} - ${c.person_name}
</option>`;
});
});

/* LOAD LEDGER */

async function load(){

if(!firm.value){
alert("Select firm");
return;
}

const res=await fetch(API+"/api/ledger-dashboard");
const data=await res.json();

const rows=data.filter(x=>x.customer_id==firm.value);

let bal=0;
tb.innerHTML="";

rows.forEach(d=>{

let bill="",receipt="",particular="";

/* INVOICE */

if(d.invoice_amount){

bill="₹"+d.invoice_amount;
bal+=d.invoice_amount;

particular =
formatPeriod(d.period_from,d.period_to);

}

/* RECEIPT */

if(d.receipt_amount){

receipt="₹"+d.receipt_amount;
bal-=d.receipt_amount;

particular=d.type;

}

tb.innerHTML+=`
<tr>
<td>${formatDate(d.date)}</td>

<td class="link"
onclick="openInvoice('${d.invoice_no}')">
${d.invoice_no||""}
</td>

<td>${particular}</td>

<td class="amount">${bill}</td>
<td class="amount">${receipt}</td>
<td class="amount">₹${bal}</td>
</tr>`;
});

}

/* FORMAT PERIOD */

function formatPeriod(f,t){

if(!f||!t) return "";

const m=["Jan","Feb","Mar","Apr","May","Jun",
"Jul","Aug","Sep","Oct","Nov","Dec"];

const d1=new Date(f);
const d2=new Date(t);

return `${m[d1.getMonth()]} ${d1.getFullYear()}
to
${m[d2.getMonth()]} ${d2.getFullYear()}`;
}

/* FORMAT DATE */

function formatDate(d){
return new Date(d).toLocaleDateString("en-GB");
}

/* OPEN INVOICE */

function openInvoice(no){
if(no) window.open("invoice.html?invoice="+no);
}

/* SHARE */

function shareLedger(){

html2canvas(ledgerPage).then(canvas=>{
canvas.toBlob(blob=>{
const file=new File([blob],"Ledger.jpg",{type:"image/jpeg"});
navigator.share({files:[file],title:"Ledger"});
});
});
}

</script>

</body>
</html>
