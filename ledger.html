<!DOCTYPE html>
<html>
<head>
<title>Ledger Statement</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>

body{
font-family:Segoe UI;
background:#eef2f7;
margin:0;
padding:10px;
}

/* TOP */

.top{
display:flex;
gap:8px;
flex-wrap:wrap;
margin-bottom:12px;
}

select,button{
padding:9px;
border-radius:6px;
border:1px solid #ccc;
font-size:13px;
}

button{
background:#2d4a8a;
color:white;
border:none;
cursor:pointer;
}

/* CARD */

.card{
background:white;
max-width:900px;
margin:auto;
padding:14px;
border-radius:14px;
box-shadow:0 6px 18px rgba(0,0,0,.08);
}

/* HEADER */

h2{
text-align:center;
margin:6px 0 8px;
}

.partyName{
text-align:center;
color:green;
font-weight:bold;
font-size:16px;
}

.gstin{
text-align:center;
font-size:13px;
font-weight:600;
margin-bottom:10px;
}

/* TABLE */

table{
width:100%;
border-collapse:collapse;
table-layout:fixed;
}

/* HEAD */

th{
background:#2d4a8a;
color:white;
padding:8px;
font-size:12px;
}

/* BODY */

td{
padding:8px 6px;
border-bottom:1px solid #ddd;
font-size:12px;
text-align:center;
white-space:nowrap;
}

/* ===== COLUMN WIDTHS ===== */
/* Adjusted for mobile PDF fit */

.col-date{width:18%;}
.col-no{width:15%;}
.col-particular{
width:28%;
white-space:normal;      /* allow wrap */
word-break:break-word;
}
.col-bill{width:13%;}
.col-receipt{width:13%;}
.col-balance{width:13%;}

/* COLORS */

.link{
cursor:pointer;
text-decoration:underline;
font-weight:600;
}

.receiptNo{color:green;font-weight:bold;}
.receiptAmt{color:green;font-weight:bold;}
.closingBal{color:red;font-weight:bold;}

/* MOBILE FONT SCALE */

@media(max-width:600px){

th{font-size:11px;}
td{font-size:11px;}

}

</style>
</head>

<body>

<div class="top">
<select id="firm"></select>
<button onclick="loadLedger()">Search</button>
<button onclick="sharePDF()">Share PDF</button>
<button onclick="shareJPG()">Share JPG</button>
</div>

<div id="ledgerBox" class="card">

<h2>Ledger Statement</h2>

<div id="partyDisplay" class="partyName"></div>
<div id="gstDisplay" class="gstin"></div>

<table>

<thead>
<tr>
<th class="col-date">Date</th>
<th class="col-no">No</th>
<th class="col-particular">Particular</th>
<th class="col-bill">Bill</th>
<th class="col-receipt">Receipt</th>
<th class="col-balance">Balance</th>
</tr>
</thead>

<tbody id="tb"></tbody>

</table>
</div>

<script>

const API="https://backend.rajeevyadav2596.workers.dev";

/* LOAD FIRMS */

fetch(API+"/api/customers")
.then(r=>r.json())
.then(d=>{
firm.innerHTML='<option value="">Select Party</option>';
d.forEach(c=>{
firm.innerHTML+=`
<option value="${c.id}" data-gst="${c.gstin}">
${c.firm_name} - ${c.person_name}
</option>`;
});
});

/* FORMAT */

function formatDate(dt){
return new Date(dt).toLocaleDateString("en-GB");
}

function formatPeriod(f,t){
if(!f||!t) return "";
const m=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
let d1=new Date(f);
let d2=new Date(t);
return `${m[d1.getMonth()]}-${d1.getFullYear()} to ${m[d2.getMonth()]}-${d2.getFullYear()}`;
}

function formatNumber(n){
return Number(n).toLocaleString("en-IN");
}

/* LOAD LEDGER */

async function loadLedger(){

const selected=firm.options[firm.selectedIndex];

partyDisplay.innerText=selected.text||"";
gstDisplay.innerText="GSTIN: "+(selected.dataset.gst||"");

const res=await fetch(API+"/api/ledger-dashboard");
const data=await res.json();

const filtered=data.filter(x=>x.customer_id==firm.value);

let bal=0;
tb.innerHTML="";

filtered.forEach((d,i)=>{

let bill=+d.bill||0;
let receipt=+d.receipt||0;

bal+=bill;
bal-=receipt;

let particular="";
let click="";
let invClass="link";

if(d.invoice_no?.startsWith("RS-")){
particular=formatPeriod(d.period_from,d.period_to);
click=`onclick="openInvoice('${d.invoice_no}')"`
}
else if(d.invoice_no?.startsWith("P-")){
particular=d.particular||"Receipt";
click=`onclick="openReceipt('${d.invoice_no}')"`
invClass+=" receiptNo";
}

let receiptClass=receipt?"receiptAmt":"";
let balClass=(i===filtered.length-1)?"closingBal":"";

tb.innerHTML+=`
<tr>
<td class="col-date">${formatDate(d.date)}</td>
<td class="col-no ${invClass}" ${click}>${d.invoice_no||""}</td>
<td class="col-particular">${particular}</td>
<td class="col-bill">${bill?formatNumber(bill):""}</td>
<td class="col-receipt ${receiptClass}">
${receipt?formatNumber(receipt):""}
</td>
<td class="col-balance ${balClass}">
${formatNumber(bal)}
</td>
</tr>`;
});

}

/* ROUTING */

function openInvoice(no){
window.location.href=`invoice.html?invoice=${no}`;
}

function openReceipt(no){
window.location.href=`receipt.html?receipt=${no}`;
}

/* SHARE JPG */

async function shareJPG(){
const canvas=await html2canvas(ledgerBox,{scale:2});
const blob=await new Promise(r=>canvas.toBlob(r));
const file=new File([blob],"Ledger.jpg",{type:"image/jpeg"});
navigator.share
? navigator.share({files:[file]})
: window.open(URL.createObjectURL(blob));
}

/* SHARE PDF */

async function sharePDF(){

const { jsPDF } = window.jspdf;

const canvas=await html2canvas(ledgerBox,{scale:3});
const img=canvas.toDataURL("image/png");

const pdf=new jsPDF("p","mm","a4");

const w=210;
const h=(canvas.height*w)/canvas.width;

pdf.addImage(img,"PNG",0,5,w,h);

const blob=pdf.output("blob");
const file=new File([blob],"Ledger.pdf",{type:"application/pdf"});

navigator.share
? navigator.share({files:[file]})
: pdf.save("Ledger.pdf");

}

</script>

</body>
</html>
